<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="../css/pmag.css" type="text/css" />
</head>
<body>
<div id="header_wrap">
  <h1><a href="book.htm">開放電腦計畫 -- 計算機硬體結構</a><BR/><sub>(使用 Verilog 實作)</sub></h1>
  <table id="bar" border="0" style="border:0;"><tr style="border:0;">
    <td style="text-align:left;border:0;"> <a href="book.html">目錄</a> | <a href="download.html">下載</a> | <a href="course.html">課程</a> | <a href="forum.html">討論</a> | <a href="exam.html">測驗</a></td>
    <td style="text-align:right;border:0;"><a href="http://ccckmit.wikidot.com/">陳鍾誠</a> 於 <a href="http://www.nqu.edu.tw/">金門大學</a></td>
  </tr></table>
</div>
<div id="content">
<div id="TOC">
<ul>
<li><a href="#計數器模組">計數器模組</a><ul>
<li><a href="#簡易計數器">簡易計數器</a></li>
<li><a href="#程式計數器">程式計數器</a></li>
</ul></li>
</ul>
</div>
<h1 id="計數器模組"><a href="#計數器模組">計數器模組</a></h1>
<h2 id="簡易計數器"><a href="#簡易計數器">簡易計數器</a></h2>
<h3 id="簡易計數器流程版"><a href="#簡易計數器流程版">簡易計數器：流程版</a></h3>
<pre class="sourceCode Verilog"><code class="sourceCode verilog"><span class="kw">module</span> counter(<span class="dt">input</span> clk, rst, <span class="dt">output</span> <span class="dt">reg</span> [<span class="dv">2</span>:<span class="dv">0</span>] q);
    <span class="kw">always</span> @(<span class="kw">posedge</span> clk) <span class="kw">begin</span>
        <span class="kw">if</span> (rst)
            q = <span class="bn">3&#39;b000</span>;
        <span class="kw">else</span>
            q = q<span class="dv">+1</span>;
    <span class="kw">end</span>
<span class="kw">endmodule</span>

<span class="kw">module</span> main;
<span class="dt">reg</span> clk;
<span class="dt">reg</span> rst;
<span class="dt">wire</span> [<span class="dv">2</span>:<span class="dv">0</span>] q;

counter DUT (.clk(clk), .rst(rst), .q(q));

<span class="kw">initial</span>
<span class="kw">begin</span>
  <span class="dt">$monitor</span>(<span class="st">&quot;%4dns monitor: q=%d&quot;</span>, <span class="dt">$stime</span>, q);
  clk = <span class="dv">0</span>;
  rst = <span class="dv">1</span>;
  <span class="bn">#100</span> rst = <span class="dv">0</span>;
  <span class="bn">#1000</span> <span class="dt">$finish</span>;
<span class="kw">end</span>

<span class="kw">always</span> <span class="bn">#50</span> <span class="kw">begin</span>
  clk=clk<span class="dv">+1</span>; 
<span class="kw">end</span>

<span class="kw">endmodule</span></code></pre>
<p>執行結果</p>
<pre><code>D:\oc\code&gt;vvp counter
   0ns monitor: q=x
  50ns monitor: q=0
 150ns monitor: q=1
 250ns monitor: q=2
 350ns monitor: q=3
 450ns monitor: q=4
 550ns monitor: q=5
 650ns monitor: q=6
 750ns monitor: q=7
 850ns monitor: q=0
 950ns monitor: q=1
1050ns monitor: q=2</code></pre>
<h3 id="簡易計數器方塊版"><a href="#簡易計數器方塊版">簡易計數器：方塊版</a></h3>
<div class="figure">
<img src="../img/counter_block.jpg" alt="電路設計圖" /><p class="caption">電路設計圖</p>
</div>
<p>檔案：counter_block.v</p>
<pre class="sourceCode Verilog"><code class="sourceCode verilog"><span class="kw">module</span> inc(<span class="dt">input</span> [<span class="dv">2</span>:<span class="dv">0</span>] i, <span class="dt">output</span> [<span class="dv">2</span>:<span class="dv">0</span>] o);
  <span class="kw">assign</span> o = i + <span class="dv">1</span>;
<span class="kw">endmodule</span>

<span class="kw">module</span> register(<span class="dt">input</span> clk, rst, <span class="dt">input</span> [<span class="dv">2</span>:<span class="dv">0</span>] r_in, <span class="dt">output</span> [<span class="dv">2</span>:<span class="dv">0</span>] r_out);
  <span class="dt">reg</span> [<span class="dv">2</span>:<span class="dv">0</span>] r;
  <span class="kw">always</span> @(<span class="kw">posedge</span> clk) <span class="kw">begin</span>
    <span class="kw">if</span> (rst)
      r = <span class="bn">3&#39;b000</span>;
    <span class="kw">else</span>
      r = r_in;
  <span class="kw">end</span>
  <span class="kw">assign</span> r_out = r;
<span class="kw">endmodule</span>

<span class="kw">module</span> counter;
<span class="dt">reg</span> clk;
<span class="dt">reg</span> rst;
<span class="dt">wire</span> [<span class="dv">2</span>:<span class="dv">0</span>] c_in, c_out;

register c(clk, rst, c_in, c_out);
inc inc1(c_out, c_in);

<span class="kw">initial</span>
<span class="kw">begin</span>
  <span class="dt">$monitor</span>(<span class="st">&quot;%4dns monitor: c.r=%d&quot;</span>, <span class="dt">$stime</span>, c.r);
  clk = <span class="dv">0</span>;
  rst = <span class="dv">1</span>;
  <span class="bn">#100</span> rst = <span class="dv">0</span>;
  <span class="bn">#1000</span> <span class="dt">$finish</span>;
<span class="kw">end</span>
<span class="kw">always</span> <span class="bn">#50</span> <span class="kw">begin</span>
  clk=clk<span class="dv">+1</span>; 
<span class="kw">end</span>

<span class="kw">endmodule</span></code></pre>
<p>執行結果</p>
<pre><code>D:\oc\code&gt;iverilog -o counter_block counter_block.v

D:\oc\code&gt;vvp counter_block
   0ns monitor: c.r=x
  50ns monitor: c.r=0
 150ns monitor: c.r=1
 250ns monitor: c.r=2
 350ns monitor: c.r=3
 450ns monitor: c.r=4
 550ns monitor: c.r=5
 650ns monitor: c.r=6
 750ns monitor: c.r=7
 850ns monitor: c.r=0
 950ns monitor: c.r=1
1050ns monitor: c.r=2</code></pre>
<h2 id="程式計數器"><a href="#程式計數器">程式計數器</a></h2>
<h3 id="程式計數器流程版"><a href="#程式計數器流程版">程式計數器：流程版</a></h3>
<p>檔案：pctick.v</p>
<pre class="sourceCode Verilog"><code class="sourceCode verilog"><span class="kw">module</span> pcTick(<span class="dt">input</span> clock, reset, <span class="dt">output</span> <span class="dt">reg</span> [<span class="dv">31</span>:<span class="dv">0</span>] pc, 
             <span class="dt">output</span> <span class="dt">reg</span> [<span class="dv">2</span>:<span class="dv">0</span>] tick);
    <span class="kw">always</span> @(<span class="kw">posedge</span> clock) <span class="kw">begin</span>
        <span class="kw">if</span> (reset) 
          <span class="kw">begin</span>
            pc = <span class="dv">0</span>;
            tick = <span class="dv">0</span>;
          <span class="kw">end</span>
        <span class="kw">else</span> <span class="kw">begin</span>
            tick = tick<span class="dv">+1</span>;
            <span class="kw">if</span> (tick == <span class="dv">6</span>) <span class="kw">begin</span>
                tick = <span class="dv">0</span>;
                pc = pc<span class="dv">+4</span>;
            <span class="kw">end</span>
            <span class="dt">$monitor</span>(<span class="st">&quot;%4dns %8x %1x&quot;</span>, <span class="dt">$stime</span>, pc, tick);
        <span class="kw">end</span>
    <span class="kw">end</span>
<span class="kw">endmodule</span>

<span class="kw">module</span> main;
<span class="dt">reg</span> clock;
<span class="dt">reg</span> reset;
<span class="dt">wire</span> [<span class="dv">2</span>:<span class="dv">0</span>] tick;
<span class="dt">wire</span> [<span class="dv">31</span>:<span class="dv">0</span>] pc;

pcTick DUT (.clock(clock), .reset(reset), .pc(pc), .tick(tick));

<span class="kw">initial</span>
<span class="kw">begin</span>
  clock = <span class="dv">0</span>;
  reset = <span class="dv">1</span>;
  <span class="bn">#100</span> reset=<span class="dv">0</span>;
  <span class="bn">#2000</span> <span class="dt">$finish</span>;
<span class="kw">end</span>

<span class="kw">always</span> <span class="bn">#50</span> clock=clock<span class="dv">+1</span>;
<span class="kw">endmodule</span></code></pre>
<p>執行結果：</p>
<pre><code>D:\Dropbox\Public\oc\code&gt;iverilog -o pctick pctick.v

D:\Dropbox\Public\oc\code&gt;vvp pctick
 150ns 00000000 1
 250ns 00000000 2
 350ns 00000000 3
 450ns 00000000 4
 550ns 00000000 5
 650ns 00000004 0
 750ns 00000004 1
 850ns 00000004 2
 950ns 00000004 3
1050ns 00000004 4
1150ns 00000004 5
1250ns 00000008 0
1350ns 00000008 1
1450ns 00000008 2
1550ns 00000008 3
1650ns 00000008 4
1750ns 00000008 5
1850ns 0000000c 0
1950ns 0000000c 1
2050ns 0000000c 2</code></pre>
<h3 id="程式計數器方塊版"><a href="#程式計數器方塊版">程式計數器：方塊版</a></h3>
<p>檔案：pctick_block.v</p>
<pre class="sourceCode Verilog"><code class="sourceCode verilog"><span class="kw">module</span> pcTick(<span class="dt">input</span> clock, reset, <span class="dt">input</span> [<span class="dv">31</span>:<span class="dv">0</span>] pc_in, <span class="dt">output</span> [<span class="dv">31</span>:<span class="dv">0</span>] pc_out, <span class="dt">output</span> <span class="dt">reg</span> [<span class="dv">2</span>:<span class="dv">0</span>] tick);
  <span class="dt">reg</span> [<span class="dv">31</span>:<span class="dv">0</span>] pc;
  <span class="kw">always</span> @(<span class="kw">posedge</span> clock) <span class="kw">begin</span>
    <span class="kw">if</span> (reset) <span class="kw">begin</span>
      pc = <span class="dv">0</span>;
      tick = <span class="dv">0</span>;
    <span class="kw">end</span> <span class="kw">else</span> <span class="kw">begin</span>
      tick = tick<span class="dv">+1</span>;
      <span class="kw">if</span> (tick == <span class="dv">6</span>) <span class="kw">begin</span>
        tick = <span class="dv">0</span>;
        pc = pc_in;
      <span class="kw">end</span>
      <span class="dt">$monitor</span>(<span class="st">&quot;%4dns %8x %1x&quot;</span>, <span class="dt">$stime</span>, pc, tick);
    <span class="kw">end</span>
  <span class="kw">end</span>
  <span class="kw">assign</span> pc_out = pc;
<span class="kw">endmodule</span>

<span class="kw">module</span> alu(<span class="dt">input</span> [<span class="dv">31</span>:<span class="dv">0</span>] a, <span class="dt">input</span> [<span class="dv">31</span>:<span class="dv">0</span>] b, <span class="dt">input</span> [<span class="dv">3</span>:<span class="dv">0</span>] op, <span class="dt">output</span> <span class="dt">reg</span> [<span class="dv">31</span>:<span class="dv">0</span>] y);
<span class="dt">parameter</span> [<span class="dv">3</span>:<span class="dv">0</span>] PASS=<span class="bn">4&#39;h2</span>, ADD=<span class="bn">4&#39;h3</span>, SUB=<span class="bn">4&#39;h4</span>, MUL=<span class="bn">4&#39;h5</span>, DIV=<span class="bn">4&#39;h6</span>, AND=<span class="bn">4&#39;h8</span>, OR=<span class="bn">4&#39;h9</span>, XOR=<span class="bn">4&#39;hA</span>, SHL=<span class="bn">4&#39;hE</span>, SHR=<span class="bn">4&#39;hF</span>; <span class="co">// ALU 運算碼</span>
always@(a <span class="dt">or</span> b <span class="dt">or</span> op) <span class="kw">begin</span>
  <span class="kw">case</span>(op)
    <span class="dv">PASS:</span>y = a;
    <span class="dv">ADD:</span> y = a + b;
    <span class="dv">SUB:</span> y = a - b;
    <span class="dv">MUL:</span> y = a * b;
    <span class="dv">DIV:</span> y = a / b;
    <span class="dv">AND:</span> y = a &amp; b;
    <span class="dv">OR :</span> y = a | b;
    <span class="dv">XOR:</span> y = a ^ b;
    <span class="dv">SHL:</span> y = a &lt;&lt; b;
    <span class="dv">SHR:</span> y = a &gt;&gt; b;
  <span class="kw">endcase</span>
<span class="kw">end</span>
<span class="kw">endmodule</span>

<span class="kw">module</span> main;
<span class="dt">reg</span> clock;
<span class="dt">reg</span> reset;
<span class="dt">wire</span> [<span class="dv">2</span>:<span class="dv">0</span>] tick;
<span class="dt">wire</span> [<span class="dv">31</span>:<span class="dv">0</span>] pc_in, pc_out;

pcTick DUT (clock, reset, pc_in, pc_out, tick);
alu alu0(pc_out, <span class="dv">4</span>, alu0.ADD, pc_in);

<span class="kw">initial</span>
<span class="kw">begin</span>
  clock = <span class="dv">0</span>;
  reset = <span class="dv">1</span>;
  <span class="bn">#100</span> reset=<span class="dv">0</span>;
  <span class="bn">#2000</span> <span class="dt">$finish</span>;
<span class="kw">end</span>

<span class="kw">always</span> <span class="bn">#50</span> clock=clock<span class="dv">+1</span>;
<span class="kw">endmodule</span></code></pre>
<p>執行結果：</p>
<pre><code>D:\Dropbox\Public\oc\code&gt;iverilog -o pctick_block pctick_block.v

D:\Dropbox\Public\oc\code&gt;vvp pctick_block
 150ns 00000000 1
 250ns 00000000 2
 350ns 00000000 3
 450ns 00000000 4
 550ns 00000000 5
 650ns 00000004 0
 750ns 00000004 1
 850ns 00000004 2
 950ns 00000004 3
1050ns 00000004 4
1150ns 00000004 5
1250ns 00000008 0
1350ns 00000008 1
1450ns 00000008 2
1550ns 00000008 3
1650ns 00000008 4
1750ns 00000008 5
1850ns 0000000c 0
1950ns 0000000c 1
2050ns 0000000c 2</code></pre>
</div>
<div id="footer">
<a href="http://ccckmit.wikidot.com">陳鍾誠</a>衍生自<a href="http://zh.wikipedia.org/">維基百科</a>之作品：採用 <a href="http://creativecommons.org/licenses/by-sa/3.0/tw/ ">創作共用：姓名標示、相同方式分享</a> <a href="license.html">授權</a>
</div>
</body>
</html>
